#!/bin/bash

# Copyright (c) 2019, James Bowen, All Rights Reserved

# Output to stderr if no logfile passed
SYNOPKG_TEMP_LOGFILE=${SYNOPKG_TEMP_LOGFILE:-"/dev/stderr"}

# Verify required environment variables set
for var in SYNOPKG_PKG_STATUS SYNOPKG_PKGDEST_VOL SYNOPKG_PKGNAME; do
    eval "val=\$$var"
    if [ -z "$val" ]; then
        echo "ERROR: Required environment variable '$var' not set." >> ${SYNOPKG_TEMP_LOGFILE}
        exit 1
    fi
done

# Perform the following only during initial installation
if [ "${SYNOPKG_PKG_STATUS}" = "INSTALL" ]; then

    config="/var/packages/${SYNOPKG_PKGNAME}/etc/config.ini"

    # Install wizard parameters
    data_dir=${GRAFANA_DATA_DIR:-"${SYNOPKG_PKGDEST_VOL}/data/${SYNOPKG_PKGNAME}"}
    data_port=${GRAFANA_PORT:-3000}

    # Generate default config based on values from wizard
    cat >${config} <<-END_OF_CONFIG
# Default Grafana Configuration
# Autogenerated on $(date)

[paths]
  data = "${data_dir}"

[server]
  http_port = "${data_port}"
END_OF_CONFIG

    if [ $? -ne 0 ]; then
        echo "ERROR: Could not create config file." >> ${SYNOPKG_TEMP_LOGFILE}
        exit 2
    fi

    if [ ! -d "${data_dir}" ]; then
        mkdir -p "${data_dir}"
        chown grafana.grafana "${data_dir}"
    fi
fi

exit 0