#!/bin/bash

# Copyright (c) 2017, James Bowen, All Rights Reserved

# Create symlinks for startup/shutdown
tgt="/var/packages/${SYNOPKG_PKGNAME}/scripts/start-stop-status"
link="/usr/local/etc/rc.d/${SYNOPKG_PKGNAME}.sh"

if [ ! -e "${link}" ]; then
    err=$(ln -s ${tgt} ${link} 2>&1)
    if [ $? -ne 0 ]; then
        echo "ERROR: Could not create symlink: ${err}" >> ${SYNOPKG_TEMP_LOGFILE}
        exit 1
    fi
fi

# Generate default config if not present
config="/var/packages/${SYNOPKG_PKGNAME}/etc/influxdb.conf"
data_dir=${INFLUXDB_DATA_DIR:-"/var/packages/${SYNOPKG_PKGNAME}/target/data"}

if [ ! -f "${config}" ]; then
    cat >${config} <<-END_OF_CONFIG
# Default InfluxDB Configuration
# Autogenerated on $(date)

[meta]
  dir = "${data_dir}/meta"

[data]
  dir = "${data_dir}/data"
  wal-dir = "${data_dir}/wal"
END_OF_CONFIG
    if [ $? -ne 0 ]; then
        echo "ERROR: Could not create config file." >> ${SYNOPKG_TEMP_LOGFILE}
        exit 2
    fi
fi

mkdir -p ${data_dir}
chown influxDB.influxDB ${data_dir}

exit 0
