#!/bin/bash

# Copyright (c) 2017, James Bowen, All Rights Reserved

# Output to stderr if no logfile passed
SYNOPKG_TEMP_LOGFILE=${SYNOPKG_TEMP_LOGFILE:-"/dev/stderr"}

# Verify required environment variables set
for var in SYNOPKG_PKG_STATUS SYNOPKG_PKGDEST_VOL SYNOPKG_PKGNAME; do
    eval "val=\$$var"
    if [ -z "$val" ]; then
        echo "ERROR: Required environment variable '$var' not set." >> ${SYNOPKG_TEMP_LOGFILE}
        exit 1
    fi
done


# Create symlinks for startup/shutdown
tgt="/var/packages/${SYNOPKG_PKGNAME}/scripts/start-stop-status"
link="/usr/local/etc/rc.d/${SYNOPKG_PKGNAME}.sh"

if [ ! -e "${link}" ]; then
    err=$(ln -s ${tgt} ${link} 2>&1)
    if [ $? -ne 0 ]; then
        echo "ERROR: Could not create symlink: ${err}" >> ${SYNOPKG_TEMP_LOGFILE}
        exit 1
    fi
fi

# Perform the following only during initial installation
if [ "${SYNOPKG_PKG_STATUS}" = "INSTALL" ]; then

    config="/var/packages/${SYNOPKG_PKGNAME}/etc/influxdb.conf"

    # Install wizard parameters
    data_dir=${INFLUXDB_DATA_DIR:-"${SYNOPKG_PKGDEST_VOL}/data/${SYNOPKG_PKGNAME}"}
    data_port=${INFLUXDB_PORT:-8088}

    # Generate default config based on values from wizard
    cat >${config} <<-END_OF_CONFIG
# Default InfluxDB Configuration
# Autogenerated on $(date)

[meta]
  dir = "${data_dir}/meta"

[data]
  dir = "${data_dir}/data"
  wal-dir = "${data_dir}/wal"

[http]
  bind-address = ":${data_port}"

END_OF_CONFIG
    if [ $? -ne 0 ]; then
        echo "ERROR: Could not create config file." >> ${SYNOPKG_TEMP_LOGFILE}
        exit 2
    fi

    if [ ! -d "${data_dir}" ]; then
        mkdir -p "${data_dir}"
        chown influxDB.influxDB "${data_dir}"
    fi
fi

exit 0
